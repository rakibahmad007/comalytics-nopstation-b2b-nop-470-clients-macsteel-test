@using NopStation.Plugin.B2B.ManageB2CandB2BCustomer.Models

@model B2CShipToAddressModel
@inject B2BB2CFeaturesSettings b2BB2CFeaturesSettings

@{
    Layout = "_ColumnsOne";
    var returnUrl = ViewBag.ReturnUrl as string;
    if (string.IsNullOrEmpty(returnUrl))
    {
        returnUrl = Url.RouteUrl("Homepage");
    }
    var defaultAddressChanged = ViewBag.DefaultAddressChanged;
}

<style>
    #map {
        height: 500px;
        margin-bottom: 30px;
    }

    #description {
        font-family: Roboto;
        font-size: 15px;
        font-weight: 300;
    }

    #infowindow-content .title {
        font-weight: bold;
    }

    #infowindow-content {
        display: none;
    }

    #map #infowindow-content {
        display: inline;
    }

    .address-input-card {
        margin: 10px;
        overflow: hidden;
        padding: 0;
        width: 92%;
        height: 40px;
        border-radius: 2px;
        box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.3);
        left: 0 !important;
    }

    .pac-controls, .map-controls {
        display: inline-block;
        padding: 5px 11px;
    }

        .pac-controls label, .map-controls label {
            font-family: Roboto;
            font-size: 13px;
            font-weight: 300;
        }

    #address-input {
        background-color: #fff;
        text-overflow: ellipsis;
        width: 100%;
        border: none !important;
        border-radius: 0px !important;
        padding-bottom: 6px;
    }

    #title {
        color: #fff;
        background-color: #4d90fe;
        font-size: 25px;
        font-weight: 500;
        padding: 6px 12px;
    }

    .b2c-shipping-address-create-page .page-body {
        width: 100%;
    }

    .b2c-shipping-address-create-page .fieldset {
        justify-content: center;
        flex-direction: column;
        align-items: center;
    }

    .b2c-shipping-address-create-page .shipping-address-google-map {
        width: 45%;
    }

    .b2c-shipping-address-create-page .address-form-area {
        width: 45%;
        display: flex;
        flex-direction: column;
    }

    .b2c-shipping-address-create-page .address-form {
        border: 1px solid black;
        padding: 4% 10%;
        margin-bottom: 20px;
    }

    .b2c-shipping-address-create-page .buttons {
        text-align: left;
        margin-top: 10px;
    }

    .gmnoprint[role="menubar"] {
        bottom: 0px;
        top: auto !important;
    }

        .gmnoprint[role="menubar"] .gm-style-mtc {
            width: 85px;
            height: 0;
            float: none !important;
        }

            .gmnoprint[role="menubar"] .gm-style-mtc button {
                height: 100% !important;
                width: 100%;
                border-radius: 10px !important;
                background: transparent !important;
                color: transparent !important;
                font-size: 0 !important;
                display: none !important;
            }

    .gm-style-mtc ul[role="menu"] {
        bottom: 90px;
        top: auto !important;
        right: 10px !important;
        display: none !important;
    }

    .gm-style-mtc li[role="menuitemcheckbox"] {
        font-size: 15px !important;
        display: none !important;
    }

    .toggle-map-button {
        position: absolute;
        z-index: 1;
        bottom: 24px !important;
        left: 10px !important;
        width: 75px;
        height: 75px;
        text-align: center;
        background-color: #fff;
        border: none;
        outline: none;
        border-radius: 10px !important;
        background-image: url('Plugins/NopStation.Plugin.B2B.ManageB2CandB2BCustomer/Content/img/satellite_thumb.png');
        background-repeat: no-repeat;
        background-position: center;
        background-size: 90px;
        margin: 0px;
        padding: 10px;
        text-transform: none;
        appearance: none;
        cursor: pointer;
        user-select: none;
        direction: ltr;
        overflow: hidden;
        text-align: center;
        vertical-align: middle;
        color: #fff;
        font-family: Roboto, Arial, sans-serif;
        font-size: 15px;
        border-bottom-left-radius: 2px;
        border-top-left-radius: 2px;
        box-shadow: rgba(0, 0, 0, 0.3) 0px 1px 4px -1px;
        min-width: 66px;
        font-weight: 500;
    }

    a[rel="noopener"] {
        display: none !important;
    }

    .message-error {
        margin-left: 0 !important;
    }

    div[aria-describedby="ExpressShopZoneDialog"] {
        position: fixed !important;
        left: 50% !important;
        top: 50% !important;
        transform: translate(-50%, -50%) !important;
    }

    div[aria-describedby="SalesOrgDifferentwarningDialog"] .ui-dialog-titlebar-close {
        pointer-events: auto !important;
    }

    div[aria-describedby="ExpressShopZoneDialog"] .ui-dialog-titlebar-close {
        pointer-events: auto !important;
    }

    div[aria-describedby="ErrorWarningDialog"] .ui-dialog-titlebar-close {
        pointer-events: auto !important;
    }

    div[aria-describedby="IsShipToAddressAlreadyExistDialog"] .ui-dialog-titlebar-close {
        pointer-events: auto !important;
    }

    div[aria-describedby="IsShipToAddressIsInDeliveryRoute"] .ui-dialog-titlebar-close {
        pointer-events: auto !important;
    }

    .pac-container {
        pointer-events: auto !important;
    }

    .BtnCloseIsShipToAddressIsInDeliveryRouteDialog {
        text-align: center !important;
        display: flex;
        justify-content: center;
    }
</style>

<div class="page b2c-shipping-address-create-page">
    <div class="page-title">
        <h1>@T("NopStation.Plugin.B2B.ManageB2CandB2BCustomer.B2CShipToAddressSelector.Create")</h1>
    </div>
    <div class="page-body">
        <form id="CreateShippingAddress" asp-route="CreateShippingAddress" asp-route-returnurl="@returnUrl" method="post">
            <div style="text-align:left !important;margin-bottom:40px;" asp-validation-summary="ModelOnly" class="message-error">
            </div>
            <div class="fieldset">
                <div class="address-form-area">
                    <div hidden id="addressForm" class="address-form" action="" method="get" autocomplete="off">
                        <div hidden id="latitudeDiv" class="inputs">
                            <label asp-for="Latitude" asp-postfix=":"></label>
                            <input asp-for="Latitude" id="latitude" readonly />
                            <nop-required />
                            <span asp-validation-for="Latitude"></span>
                        </div>
                        <div hidden id="longitudeDiv" class="inputs">
                            <label asp-for="Longitude" asp-postfix=":"></label>
                            <input asp-for="Longitude" id="longitude" readonly />
                            <nop-required />
                            <span asp-validation-for="Longitude"></span>
                        </div>
                        <div hidden id="houseNumberDiv" class="inputs">
                            <label asp-for="HouseNumber" asp-postfix=":"></label>
                            <input asp-for="HouseNumber" id="houseNumber" />
                            <nop-required />
                            <span asp-validation-for="HouseNumber"></span>
                        </div>
                        <div hidden id="streetDiv" class="inputs">
                            <label asp-for="Street" asp-postfix=":"></label>
                            <input asp-for="Street" id="street" />
                            <nop-required />
                            <span asp-validation-for="Street"></span>
                        </div>
                        <div hidden id="suburbDiv" class="inputs">
                            <label asp-for="Suburb" asp-postfix=":"></label>
                            <input asp-for="Suburb" id="suburb" />
                            <nop-required />
                            <span asp-validation-for="Suburb"></span>
                        </div>
                        <div hidden id="cityDiv" class="inputs">
                            <label asp-for="City" asp-postfix=":"></label>
                            <input asp-for="City" id="city" />
                            <nop-required />
                            <span asp-validation-for="City"></span>
                        </div>
                        <div hidden id="stateProvinceDiv" class="inputs">
                            <label asp-for="StateProvince" asp-postfix=":"></label>
                            <input asp-for="StateProvince" id="stateProvince" />
                            <nop-required />
                            <span asp-validation-for="StateProvince"></span>
                        </div>
                        <div hidden id="postalCodeDiv" class="inputs">
                            <label asp-for="PostalCode" asp-postfix=":"></label>
                            <input asp-for="PostalCode" id="postalCode" />
                            <nop-required />
                            <span asp-validation-for="PostalCode"></span>
                        </div>
                        <div class="inputs" hidden>
                            <label asp-for="StateProvinceCode" asp-postfix=":"></label>
                            <input asp-for="StateProvinceCode" id="stateProvinceCode" />
                            <nop-required />
                            <span asp-validation-for="StateProvinceCode"></span>
                        </div>
                        <div hidden id="countryDiv" class="inputs country-input">
                            <label asp-for="Country" asp-postfix=":"></label>
                            <input asp-for="Country" id="country" />
                            <nop-required />
                            <span asp-validation-for="Country"></span>
                        </div>
                        <div class="inputs" hidden>
                            <label asp-for="CountryCode" asp-postfix=":"></label>
                            <input asp-for="CountryCode" id="countryCode" />
                            <nop-required />
                            <span asp-validation-for="CountryCode"></span>
                        </div>
                    </div>

                    <!--
                    The `defer` attribute causes the callback to execute after the full HTML
                    document has been parsed. For non-blocking uses, avoiding race conditions,
                    and consistent behavior across browsers, consider loading using Promises
                    with-->
                    @*                     <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDKtIRU8pgWIOf8PNPnOsbP4DDD8ohIfrE&callback=initMap&libraries=places&v=weekly" defer></script>
                    <br /> *@

                    <input hidden asp-for="DistanceToNearestWarehouse" id="distanceToNearestWarehouse" />
                    <input hidden asp-for="IsCustomerOnDeliveryRoute" id="isCustomerOnDeliveryRoute" />
                    <input hidden asp-for="NearestWarehouseCode" id="nearestWarehouseCode" />
                    <input hidden asp-for="RouteCode"/>
                </div>
                <div class="b2c-shipping-address shipping-address-google-map">
                    <div class="address-input-card" id="address-input-card">
                        <div id="address-input-container">
                            <input id="address-input" type="text" placeholder="Enter your delivery address here or click to pin your location on the map below" />
                        </div>
                    </div>
                    <button id="toggle-map-button" class="toggle-map-button" value="map">Satellite</button>
                    <div id="map"></div>
                    <div id="infowindow-content">
                        <span id="place-name"></span><br />
                        <span id="place-address"></span><br />
                        <span id="place-lng"></span>
                        <span id="place-lat"></span>
                    </div>
                </div>
                <div class="buttons">
                    <input hidden id="submitForm" type="submit" />
                    <input type="button" value="@T("NopStation.Plugin.B2B.ManageB2CandB2BCustomer.B2CShipToAddressSelector.Save")" class="button-1" onclick="CheckShiptoAddressIfExist()" />
                </div>
            </div>
        </form>
    </div>
</div>

<div id="SalesOrgDifferentwarningDialog" class="custom-modal" title="@T("NopStation.Plugin.B2B.ManageB2CandB2BCustomer.B2CShipToAddressSelector.Warning")" style="display: none;">
    <div class="popup-content">
        @T("NopStation.Plugin.B2B.ManageB2CandB2BCustomer.B2CShipToAddressSelector.SalesOrgDifferentwarningDialog.Text")
    </div>
    <div class="ship-to-address-selector-buttons ship-to-address-selector-warning-buttons popup-button-wrapper">
        <button type="button" value="@T("NopStation.Plugin.B2B.ManageB2CandB2BCustomer.B2CShipToAddressSelector.Cancel")"
                class="button-1 popup-button" onclick="Close()">
            <span>@T("NopStation.Plugin.B2B.ManageB2CandB2BCustomer.B2CShipToAddressSelector.Cancel")</span>
        </button>
        <button type="button" value="@T("NopStation.Plugin.B2B.ManageB2CandB2BCustomer.B2CShipToAddressSelector.Continue")" class="button-1 popup-button"
                onclick="ClearCartAndSubmitForm()">
            <span>@T("NopStation.Plugin.B2B.ManageB2CandB2BCustomer.B2CShipToAddressSelector.Continue")</span>
        </button>
    </div>
    <script asp-location="Footer">
        function Close() {
            $("#SalesOrgDifferentwarningDialog").dialog("destroy");
        }
    </script>
</div>

<div id="ExpressShopZoneDialog" class="custom-modal" title="@T("NopStation.Plugin.B2B.ManageB2CandB2BCustomer.B2CShipToAddressSelector.Warning")" style="display: none;">

    <div class="popup-content">
        <span id="expressMessage"></span>
    </div>
</div>

<div id="ErrorWarningDialog" class="custom-modal" title="@T("NopStation.Plugin.B2B.ManageB2CandB2BCustomer.B2CShipToAddressSelector.Create.Error.Title")" style="display: none;">
    <div class="popup-content">
        @T("NopStation.Plugin.B2B.ManageB2CandB2BCustomer.B2CShipToAddressSelector.Create.Error.Text")
    </div>
</div>

<div id="IsShipToAddressAlreadyExistDialog" class="custom-modal" title="@T("NopStation.Plugin.B2B.ManageB2CandB2BCustomer.B2CShipToAddressSelector.Warning")" style="display: none;">
    <div class="popup-content">
        @T("NopStation.Plugin.B2B.ManageB2CandB2BCustomer.B2CShipToAddressSelector.IsShipToAddressAlreadyExist.True")
    </div>
    <div class="ship-to-address-selector-buttons address-exists-popup-cancel-button popup-button-wrapper">
        <button type="button" class="button-1 popup-button" onclick="CloseIsShipToAddressAlreadyExistDialog()">
            @T("NopStation.Plugin.B2B.ManageB2CandB2BCustomer.B2CShipToAddressSelector.Already.Exists.Cancel")
        </button>
    </div>
    <script asp-location="Footer">
        function CloseIsShipToAddressAlreadyExistDialog() {
            $("#IsShipToAddressAlreadyExistDialog").dialog("destroy");
        }
    </script>
</div>

<div id="IsShipToAddressIsInDeliveryRoute" class="custom-modal" title="@T("NopStation.Plugin.B2B.ManageB2CandB2BCustomer.B2CShipToAddressSelector.Notification")" style="display: none;">
    <div class="popup-content">
        @T("NopStation.Plugin.B2B.ManageB2CandB2BCustomer.B2CShipToAddressSelector.IsShipToAddressIsInDeliveryRoute.False.Notification")
    </div>
    <div class="popup-content">
        @T("NopStation.Plugin.B2B.ManageB2CandB2BCustomer.B2CShipToAddressSelector.ShipToAddress.Created.Successfully")
    </div>
    <div class="BtnCloseIsShipToAddressIsInDeliveryRouteDialog popup-button-wrapper">
        <button type="button" class="button-1 popup-button" onclick="CloseIsShipToAddressIsInDeliveryRouteDialog()">
            @T("NopStation.Plugin.B2B.ManageB2CandB2BCustomer.B2CShipToAddressSelector.Continue")
        </button>
    </div>
    <script asp-location="Footer">
        function CloseIsShipToAddressIsInDeliveryRouteDialog() {
            window.location.href = "@returnUrl";
        }
    </script>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <script asp-location="Footer">
        $(function () {
            $("#IsShipToAddressIsInDeliveryRoute").dialog({
                modal: true,
                draggable: false,
                closeOnEscape: true,
                close: CloseIsShipToAddressIsInDeliveryRouteDialog
            });
        });
    </script>
}

<script>
    function initMap() {
        const latitude = document.getElementById("latitude");
        const longitude = document.getElementById("longitude");
        const houseNumber = document.getElementById("houseNumber");
        const street = document.getElementById("street");
        const suburb = document.getElementById("suburb");
        const city = document.getElementById("city");
        const stateProvince = document.getElementById("stateProvince");
        const stateProvinceCode = document.getElementById("stateProvinceCode");
        const country = document.getElementById("country");
        const countryCode = document.getElementById("countryCode");
        const postalCode = document.getElementById("postalCode");
        var center = new google.maps.LatLng(@b2BB2CFeaturesSettings.Latitude, @b2BB2CFeaturesSettings.Longitude); // default Lati and Longi

        const map = new google.maps.Map(document.getElementById("map"), {
            center: center,
            zoom: 13,
            mapTypeControl: true,
            draggableCursor: 'default',
        });

        const markerArray = [];
        const card = document.getElementById("address-input-card");

        map.controls[google.maps.ControlPosition.TOP_LEFT].push(card);
        //get geolocation from browser

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };

                    //console.log(pos);
                    map.setCenter(pos);
                },
                () => {
                    handleLocationError(true, map.getCenter());
                }
            );
        } else {
            // Browser doesn't support Geolocation
            handleLocationError(false, map.getCenter());
        }

        const layerbtn = document.getElementById("toggle-map-button");
        map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(layerbtn);
        layerbtn.style.left = "10px";

        const input = document.getElementById("address-input");
        const options = {
            componentRestrictions: { country: ["za"] },
            fields: ["address_components", "formatted_address", "geometry", "name"],
            strictBounds: false,
        };

        const autocomplete = new google.maps.places.Autocomplete(input, options);
        autocomplete.bindTo("bounds", map);

        const geocoder = new google.maps.Geocoder();

        const infowindow = new google.maps.InfoWindow();
        const infowindowContent = document.getElementById("infowindow-content");

        infowindow.setContent(infowindowContent);

        var marker = new google.maps.Marker({
            map,
            anchorPoint: new google.maps.Point(0, -29),
        });

        autocomplete.addListener("place_changed", () => {
            ResetValidationError();
            document.getElementById('CreateShippingAddress').reset();
            clearMarkers();

            const place = autocomplete.getPlace();

            if (!place.geometry || !place.geometry.location) {
                //console.log("No details available for input: '" + place.name + "'");
                return;
            }

            if (place.geometry.viewport) {
                map.fitBounds(place.geometry.viewport);
            } else {
                map.setCenter(place.geometry.location);
                map.setZoom(17);
            }

            addMarker(place.geometry.location, map);

            infowindow.close();
            marker.setVisible(false);

            setInfoWindowFields(place);
            setAddressFields(place.address_components);
        });

        google.maps.event.addListener(map, "click", (event) => {
            event.stop();
            ResetValidationError();
            document.getElementById('CreateShippingAddress').reset();
            clearMarkers();
            addMarker(event.latLng, map);

            //console.log("Click event: " + event);
            //console.log("event.placeId: " + event.placeId);
            //console.log("You clicked on: " + event.latLng);

            if (event.placeId) {
                //console.log("placeId found: ");
                getPlaceInformation(event.placeId);
            }
            else {
                //console.log("placeId not found found. using geocode.");
                geocoder
                    .geocode({ location: event.latLng })
                    .then((response) => {
                        if (response.results[0]) {

                            //console.log("geocode response: ", response);
                            //console.log("geocode response.result[0]: ", response.results[0]);

                            if (response.results[0].geometry.viewport) {
                                map.fitBounds(response.results[0].geometry.viewport);
                            } else {
                                map.setCenter(response.results[0].geometry.location);
                                map.setZoom(17);
                            }

                            setInfoWindowFields(response.results[0]);
                            setAddressFields(response.results[0].address_components);
                            //} else {
                            //console.log("No results found");
                        }
                    })
                    .catch((e) => console.log("Geocoder failed due to: " + e));
            }
        });

        function getPlaceInformation(placeId) {

            //console.log("getPlaceInformation: " + placeId);

            infowindow.close();
            marker.setVisible(false);

            const place_service = new google.maps.places.PlacesService(map);

            //console.log("place_service: ");

            place_service.getDetails({ placeId: placeId }, (place, status) => {

                //console.log("getDetails: " + place.name);

                if (!place.geometry || !place.geometry.location) {
                    //console.log("No details available for input: '" + place.name);
                    return;
                }

                if (status == google.maps.places.PlacesServiceStatus.OK && place && place.geometry && place.geometry.location) {
                    if (place.geometry.viewport) {
                        map.fitBounds(place.geometry.viewport);
                    } else {
                        map.setCenter(place.geometry.location);
                        map.setZoom(17);
                    }

                    setInfoWindowFields(place);
                    setAddressFields(place.address_components);
                }
            });
        }

        function addMarker(location, map) {
            marker = new google.maps.Marker({
                position: location,
                map: map,
            });

            markerArray.push(marker);
        }

        function clearMarkers() {
            for (var i = 0; i < markerArray.length; i++) {
                markerArray[i].setMap(null);
            }
        }

        function setInfoWindowFields(placeInfo) {

            marker.setPosition(placeInfo.geometry.location);
            marker.setVisible(true);

            //console.log("infowindowContent: ");

            var placeName = "";
            if (placeInfo.name)
                placeName = placeInfo.name + ", ";

            infowindowContent.children["place-name"].textContent = placeName;
            infowindowContent.children["place-address"].textContent = placeInfo.formatted_address;
            infowindowContent.children["place-lng"].textContent = placeInfo.geometry.location.lng();
            infowindowContent.children["place-lat"].textContent = placeInfo.geometry.location.lat();

            //console.log("place name: ", placeName);
            //console.log("place formatted address: ", placeInfo.formatted_address);
            //console.log("place longitude: ", placeInfo.geometry.location.lng());
            //console.log("place latitude: ", placeInfo.geometry.location.lat());

            infowindow.open(map, marker);

            input.value = placeName + placeInfo.formatted_address;
            latitude.value = placeInfo.geometry.location.lat();
            longitude.value = placeInfo.geometry.location.lng();
        }

        function setAddressFields(address_components) {
            //console.log("place address components: ", address_components);
            var addressComponents = address_components;

            for (const component of addressComponents) {
                const componentType = component.types;

                if (componentType.includes("street_number")) {
                    houseNumber.value = component.long_name;
                }
                else if (componentType.includes("route")) {
                    street.value = component.long_name;
                }
                else if (componentType.includes("postal_code")) {
                    postalCode.value = component.long_name;
                }
                else if (componentType.includes("locality")) {
                    city.value = component.long_name;
                }
                else if (componentType.includes("sublocality")) {
                    suburb.value = component.long_name;
                }
                else if (componentType.includes("sublocality_level_1")) {
                    suburb.value = component.long_name;
                }
                else if (componentType.includes("sublocality_level_2")) {
                    suburb.value = component.long_name;
                }
                else if (componentType.includes("administrative_area_level_1")) {
                    stateProvince.value = component.long_name;
                    stateProvinceCode.value = component.short_name;
                }
                else if (componentType.includes("country")) {
                    country.value = component.long_name;
                    countryCode.value = component.short_name;

                    ValidateCountry();
                }
            }
        }

        function handleLocationError(browserHasGeolocation, pos) {
            /*console.log("Error: The Geolocation service failed");*/
            browserHasGeolocation
                ? console.log("Error: The Geolocation service failed")
                : console.log("Error: The browser doesn't support geolocation");

            map.setCenter(pos);
        }
    }

    window.initMap = initMap;
</script>

<script asp-location="Footer">
    const addressForm = document.getElementById("addressForm");
    const countryDiv = document.getElementById("countryDiv");
    const distanceToNearestWarehouse = document.getElementById("distanceToNearestWarehouse");
    const expressMessage = document.getElementById("expressMessage");
    const isCustomerOnDeliveryRoute = document.getElementById("isCustomerOnDeliveryRoute");
    const nearestWarehouseCode = document.getElementById("nearestWarehouseCode");

    $(document).ready(function () {
        $("#country").change(function () {
            ValidateCountry();
        });

        if (@defaultAddressChanged == "1") {
            $('body').css({ "pointer-events": "none" });
            $(".center-1").css({ "pointer-events": "auto" });
            $('#SalesOrgDifferentwarningDialog').css({ "pointer-events": "auto" });
            $('#ExpressShopZoneDialog').css({ "pointer-events": "auto" });
            $('#ErrorWarningDialog').css({ "pointer-events": "auto" });
            $('#IsShipToAddressAlreadyExistDialog').css({ "pointer-events": "auto" });
            $('#IsShipToAddressIsInDeliveryRoute').css({ "pointer-events": "auto" });
        }
    });

    function CheckShiptoAddressIfExist() {
        if (ValidateForm()) {
            var newLat = $("#latitude").val();
            var newLng = $("#longitude").val();
            //console.log("newLat" + newLat);
            //console.log("newLng: " + newLng);

            //displayAjaxLoading(true);
            $.ajax({
                cache: false,
                type: "GET",
                dataType: "json",
                url: "@Url.RouteUrl("CheckShiptoAddressIfExist")",
                data: { latitude: newLat, longitude: newLng },
                success: function (response) {
                    //console.log("response: ", response);
                    if (response.Success) {
                        if (response.IsExist) {
                            $("#IsShipToAddressAlreadyExistDialog").dialog({
                                modal: true,
                                draggable: false,
                                closeOnEscape: true
                            });
                        }
                        else {
                            CheckGeoFencingResponse();
                        }
                    }
                    else {
                        $("#ErrorWarningDialog").dialog({
                            modal: true,
                            draggable: false,
                            closeOnEscape: true
                        });
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    //displayAjaxLoading(false);
                    console.log("Error. Please Reload");
                    $("#ErrorWarningDialog").dialog({
                        modal: true,
                        draggable: false,
                        closeOnEscape: true
                    });
                },
                complete: function () {
                    //displayAjaxLoading(false);
                }
            });

            //displayAjaxLoading(true);
        }
    }

    function CheckGeoFencingResponse() {
        if (ValidateForm()) {
            var newLat = $("#latitude").val();
            var newLng = $("#longitude").val();

            //console.log("new Lat: " + newLat);
            //console.log("new Lng: " + newLng);

            displayAjaxLoading(true);

            $.ajax({
                cache: false,
                type: "GET",
                dataType: "json",
                url: "@Url.RouteUrl("CheckGeoFencingResponse")",
                data: { latitude: newLat, longitude: newLng },
                success: function (response) {
                    //console.log("response: ", response);
                    if (response.Success && response.IsCustomerInExpressShopZone != null && response.IsCustomerInExpressShopZone) {
                        expressMessage.innerHTML = response.Message != null ? response.Message : "";

                        $("#ExpressShopZoneDialog").dialog({
                            modal: true,
                            draggable: false,
                            closeOnEscape: true
                        });
                    }
                    else if (response.Success && response.IsSalesOrgSame != null && response.IsSalesOrgSame) {

                        nearestWarehouseCode.value = response.NearestTradingWarehouseCode != null ? response.NearestTradingWarehouseCode : "";
                        distanceToNearestWarehouse.value = response.DistanceToNearestnearestTradingWarehouse != null ? response.DistanceToNearestnearestTradingWarehouse : 0.00;

                        if (response.IsCustomerOnDeliveryRoute != null && response.IsCustomerOnDeliveryRoute) {
                            isCustomerOnDeliveryRoute.checked = true;
                            $("#submitForm").click();
                        }
                        else {
                            isCustomerOnDeliveryRoute.checked = false;
                            $("#submitForm").click();
                        }

                        //console.log("submit form");

                    }
                    else if (response.Success && response.IsSalesOrgSame != null && !response.IsSalesOrgSame) {
                        nearestWarehouseCode.value = response.NearestTradingWarehouseCode != null ? response.NearestTradingWarehouseCode : "";
                        distanceToNearestWarehouse.value = response.DistanceToNearestnearestTradingWarehouse != null ? response.DistanceToNearestnearestTradingWarehouse : 0.00;

                        if (response.IsCustomerOnDeliveryRoute != null && response.IsCustomerOnDeliveryRoute) {
                            isCustomerOnDeliveryRoute.checked = true;
                        }
                        else {
                            isCustomerOnDeliveryRoute.checked = false;
                        }

                        $("#SalesOrgDifferentwarningDialog").dialog({
                            modal: true,
                            draggable: false,
                            closeOnEscape: true
                        });
                    }
                    else if (!response.Success) {
                        $("#ErrorWarningDialog").dialog({
                            modal: true,
                            draggable: false,
                            closeOnEscape: true
                        });
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    displayAjaxLoading(false);
                    console.log("Error. Please Reload");
                    $("#ErrorWarningDialog").dialog({
                        modal: true,
                        draggable: false,
                        closeOnEscape: true
                    });
                },
                complete: function () {
                    displayAjaxLoading(false);
                }
            });

            displayAjaxLoading(true);
        }
    }


    function ClearCartAndSubmitForm() {
        B2BAjaxCart.b2BClearCart(true);
        $("#submitForm").click();
    }

    function RemoveHiddenAttribute(element) {
        element.hidden && element.removeAttribute("hidden");
    }

    function ResetValidationError() {
        $(".field-validation-error").hide();
    }

    function ShowDiv(element) {
        RemoveHiddenAttribute(addressForm);
        RemoveHiddenAttribute(element);
    }

    function ValidateCountry() {
        var countryValue = $("#country").val().toString().toLowerCase().trim();
        if (countryValue != "" && countryValue == "south africa") {
            $(".country-input span.field-validation-error").remove();
            return true;
        }
        else {
            $(".field-validation-error").show();
            $(".country-input span.field-validation-error").remove();
            $(".country-input").append('<span class="field-validation-error">@T("Plugins.B2B.ManageB2CAndB2BCustomer.Account.Fields.Country.MustBe.SouthAfrica")</span>');

            ShowDiv(countryDiv);
            return false;
        }
    }

    function ValidateForm() {
        //console.log(document.getElementById("latitude").value);
        //console.log(document.getElementById("longitude").value);
        //console.log(document.getElementById("houseNumber").value);
        //console.log(document.getElementById("street").value);
        //console.log(document.getElementById("suburb").value);
        //console.log(document.getElementById("city").value);
        //console.log(document.getElementById("stateProvince").value);
        //console.log(document.getElementById("postalCode").value);
        //console.log(document.getElementById("country").value);

        if (document.getElementById("latitude").value == "") {
            ShowDiv(document.getElementById("latitudeDiv"));
            //console.log("lat show");
        }
        if (document.getElementById("longitude").value == "") {
            ShowDiv(document.getElementById("longitudeDiv"));
            //console.log("long show");
        }
        if (document.getElementById("houseNumber").value == "") {
            ShowDiv(document.getElementById("houseNumberDiv"));
            //console.log("hn show");
        }
        if (document.getElementById("street").value == "") {
            ShowDiv(document.getElementById("streetDiv"));
            //console.log("st show");
        }
        if (document.getElementById("suburb").value == "") {
            ShowDiv(document.getElementById("suburbDiv"));
            //console.log("su show");
        }
        if (document.getElementById("city").value == "") {
            ShowDiv(document.getElementById("cityDiv"));
            //console.log("ci show");
        }
        if (document.getElementById("stateProvince").value == "") {
            ShowDiv(document.getElementById("stateProvinceDiv"));
            //console.log("st show");
        }
        if (document.getElementById("postalCode").value == "") {
            ShowDiv(document.getElementById("postalCodeDiv"));
            //console.log("po show");
        }
        if (document.getElementById("country").value == "") {
            ShowDiv(document.getElementById("countryDiv"));
            //console.log("country show");
        }
        if ($('#CreateShippingAddress').valid()) {
            //console.log("form fields are valid. Now valdiate country");
            if (ValidateCountry()) {
                return true;
            }
            else {
                window.scrollTo(0, 0);
                return false;
            }
        }

        //console.log("form invalid");
        window.scrollTo({ top: 0, behavior: 'smooth' });
        $(".field-validation-error").show();
        window.scrollTo(0, 0);
        return false;
    }

    $(window).on('load', function () {
        $('.toggle-map-button').on('click', function (e) {
            e.stopPropagation();
            e.preventDefault();
            if ($('.toggle-map-button').val() == 'map') {
                $('.gm-style-mtc [aria-label="Show satellite imagery"]').click();
                $('.gm-style-mtc [aria-label="Show satellite imagery"]').attr('aria-checked', true);
                $('.gm-style-mtc [aria-label="Show satellite imagery"]').parents('.gm-style-mtc').css('display', 'block');
                $('.toggle-map-button').css('background-image', 'url("Plugins/NopStation.Plugin.B2B.ManageB2CandB2BCustomer/Content/img/map_thumb.png")');
                $('.toggle-map-button').css('color', '#000');

                $('.gm-style-mtc [aria-label="Show street map"]').attr('aria-checked', false);
                $('.gm-style-mtc [aria-label="Show street map"]').parents('.gm-style-mtc').css('display', 'none');
                $('.toggle-map-button').val('satellite');
                $('.toggle-map-button').html('Map');
            }

            else {
                $('.gm-style-mtc [aria-label="Show street map"]').click();
                $('.gm-style-mtc [aria-label="Show street map"]').attr('aria-checked', true);
                $('.gm-style-mtc [aria-label="Show street map"]').parents('.gm-style-mtc').css('display', 'block');
                $('.toggle-map-button').css('background-image', 'url("Plugins/NopStation.Plugin.B2B.ManageB2CandB2BCustomer/Content/img/satellite_thumb.png")');
                $('.toggle-map-button').css('color', '#fff');

                $('.gm-style-mtc [aria-label="Show satellite imagery"]').attr('aria-checked', false);
                $('.gm-style-mtc [aria-label="Show satellite imagery"]').parents('.gm-style-mtc').css('display', 'none');
                $('.toggle-map-button').val('map');
                $('.toggle-map-button').html('Satellite');
            }

        });
        $(".toggle-map-button").hover(function () {
            if ($(this).val() == 'map') {
                $('.gm-style-mtc [aria-label="Show street map"] + ul[role="menu"]').css('display', 'block');
            }
            else {
                $('.gm-style-mtc [aria-label="Show satellite imagery"] + ul[role="menu"]').css('display', 'block');
            }
        }, function () {
            if ($(this).val() == 'map') {
                $('.gm-style-mtc [aria-label="Show street map"] + ul[role="menu"]').css('display', 'none');
            }
            else {
                $('.gm-style-mtc [aria-label="Show satellite imagery"] + ul[role="menu"]').css('display', 'none');
            }
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Load Google Maps API script here
        var script = document.createElement("script");
        script.src = "https://maps.googleapis.com/maps/api/js?key=@b2BB2CFeaturesSettings.GoogleMapsApiKey&callback=initMap&libraries=places&v=weekly";

        document.head.appendChild(script);
    });
</script>