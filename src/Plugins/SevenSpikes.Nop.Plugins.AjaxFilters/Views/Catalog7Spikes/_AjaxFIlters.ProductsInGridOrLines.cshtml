@{
    var currentCustomer = await workContext.GetCurrentCustomerAsync();
    var isErpCustomer = await erpCustomerFunctionality.GetActiveErpAccountByCustomerAsync(currentCustomer) != null;
    var shoppingCartTypeId = (int)ShoppingCartType.ShoppingCart;
    var isHideWeightinfo = false;
    var isHidePricingnote = false;
    var isHideAddToCart = await erpCustomerFunctionalityService.IsHideAddToCartAsync();
    if (isErpCustomer)
    {
        var erpCustomerConfiguration = erpCustomerFunctionalityService.GetErpCustomerConfigurationOfCurrentCustomerAsync().Result;
        if (erpCustomerConfiguration != null)
        {
            isHidePricingnote = erpCustomerConfiguration.IsHidePricingNote;
            isHideWeightinfo = erpCustomerConfiguration.IsHideWeightInfo;
        }
    }
    var addToWishlistText = T("Products.Wishlist.AddToWishlist").Text;
    var checkUserRegisteredLink = Url.Action("IsShowAddToCart", "ErpAccountPublic");
}

@model ProductsModel

@{
    if (Model.ViewMode == "list")
    {
        <div class="product-b2blist nop7SpikesAjaxFiltersGrid">
            <div class="item-grid">
                <div class="table-wrapper">
                    <table class="b2blist">
                        <thead>
                            <tr>
                                <th class="sku">@T("Plugin.Misc.NopStation.Plugin.B2B.B2BB2CFeatures.Product(s).Sku")</th>
                                <th class="name">@T("Plugin.Misc.NopStation.Plugin.B2B.B2BB2CFeatures.Product(s).Name")</th>
                                <th class="on-special-product-data"></th>
                                <th class="price">@T("Plugin.Misc.NopStation.Plugin.B2B.B2BB2CFeatures.Product(s).Price")</th>
                                @if (isErpCustomer)
                                {
                                    <th class="uom">@T("Plugin.Misc.NopStation.Plugin.B2B.B2BB2CFeatures.Product(s).UOM")</th>
                                    @if (!isHidePricingnote)
                                    {
                                        <th class="pricing-note">@T("Plugin.Misc.NopStation.Plugin.B2B.B2BB2CFeatures.Product(s).PricingNotes")</th>
                                    }
                                    @if (!isHideWeightinfo)
                                    {
                                        <th class="weight">@T("Plugin.Misc.NopStation.Plugin.B2B.B2BB2CFeatures.Product(s).WeightInfo")</th>
                                    }
                                    <th class="stock">@T("Plugin.Misc.NopStation.Plugin.B2B.B2BB2CFeatures.Product(s).Stock")</th>
                                    <th class="backInStockSubscription"></th>
                                    <th class="add-to-wishlist"></th>
                                }
                                <th class="minus-btn"></th>
                                <th class="quantity">@T("Plugin.Misc.NopStation.Plugin.B2B.B2BB2CFeatures.Product(s).Qty")</th>
                                <th class="plus-btn"></th>
                                <th class="@(isHideAddToCart ? "add-to-cart-btn-not-logged-in" : "add-to-cart-btn")"></th>
                                <th class="btn-wrapper"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var product in Model.Products)
                            {
                                var addtocartPluslink = Url.RouteUrl("AddProductToCart-Catalog", new { productId = product.Id, shoppingCartTypeId = shoppingCartTypeId, quantity = 1 });
                                var addtocartMinuslink = Url.RouteUrl("RemoveProductQuantityFromCart-Catalog", new { productId = product.Id, shoppingCartTypeId = shoppingCartTypeId, quantity = 1 });

                                var addtowishlistlink = Url.RouteUrl("AddProductToCart-Catalog", new { productId = product.Id, shoppingCartTypeId = (int)ShoppingCartType.Wishlist, quantity = 1 });

                                product.CustomProperties.TryGetValue(B2BB2CFeaturesDefaults.ProductIsOnSpecial, out var OnSpecialProduct);

                                <tr class="product-item" data-productid="@product.Id">
                                    <td class="sku">@product.Sku</td>
                                    <td class="name">
                                        <a href="@Url.RouteUrl("Product", new { SeName = product.SeName })" title="@product.PictureModels.FirstOrDefault()?.Title">@product.Name</a>
                                    </td>

                                    <td class="on-special-product-data">
                                        @if (bool.TryParse(OnSpecialProduct, out var isOnSpecial) && isOnSpecial)
                                        {
                                            <div class="on-special-product">
                                                <img src="@Url.Content(B2BB2CFeaturesDefaults.ProductIsOnSpecialIconPath)" alt="Product On Special" />
                                                <span class="tooltip-text">@T("Plugin.Misc.NopStation.B2BB2CFeatures.SpecialProductMessage")</span>
                                            </div>
                                        }
                                    </td>
                                    <td class="price">@product.ProductPrice?.Price</td>
                                    @if (isErpCustomer)
                                    {
                                        <td class="uom" id="b2bUOM_@product.Id"></td>
                                        @if (!isHidePricingnote)
                                        {
                                            <td class="pricing-note" id="b2bPricingNotes_@product.Id"></td>
                                        }
                                        @if (!isHideWeightinfo)
                                        {
                                            <td class="weight" id="b2bWeightValue_@product.Id"></td>
                                        }
                                        <td class="stock" id="b2bStockAvailability_@product.Id"></td>
                                        <td class="backInStockSubscription" id="backInStockSubscription_@product.Id"></td>
                                        <button type="button" class="add-to-cart-button" data-productid="@product.Id" style="display:none;"></button>
                                        <td class="add-to-wishlist">
                                            <div id="add-to-wishlist-div" class="add-to-wishlist-div" title="@T("B2B.B2BAccountPublic.Cart.AddToWishList")" data-toggle="tooltip">
                                                <button type="button" id="add-to-wishlist-button-@product.Id" class="button-2 add-to-wishlist-button" value="@addToWishlistText" data-productid="@product.Id" onclick="AjaxCart.addproducttocart_catalog('@addtowishlistlink');return false;"></button>
                                            </div>
                                        </td>
                                    }
                                    <td class="minus-btn"><button type="button" class="counter-minus btn btn-primary" onclick="decreaseQuantity(@product.Id);return false;">-</button></td>
                                    <td class="quantity"><input id="b2bProductQty_@product.Id" class="b2bProductQty_@product.Id b2bProductQty" data-productid="@product.Id" name="productQty" value="1" style="max-width: 70px;"></td>
                                    <td class="plus-btn"><button type="button" class="counter-plus btn btn-primary" onclick="increaseQuantity(@product.Id);return false;">+</button></td>

                                    @if (!isHideAddToCart)
                                    {
                                        <td class="add-to-cart-btn">
                                            <button type="button" class="b2bAddToCart button-1 add-to-cart" onclick="productAddToCart(@product.Id)" data-productid="@product.Id" name="productQty">@T("ShoppingCart.AddToCart")</button>
                                        </td>
                                    }
                                    else
                                    {
                                        <td class="add-to-cart-btn-not-logged-in">
                                            <input type="button" value="@T("ShoppingCart.AddToCart")" class="button-1 not-logged-in-add-to-cart-button" data-productid="@product.Id" />
                                        </td>
                                    }
                                    <td class="btn-wrapper"></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                @{
                    var productIdList = Model.Products.Select(x => x.Id).ToList();
                    var productIds = string.Join(",", productIdList);
                }
                <script>

                    function backInStockSubscriptionClick(productId) {
                        displayPopupContentFromUrl('backinstocksubscribe/' + productId, '@T("BackInStockSubscriptions.NotifyMeWhenAvailable")');
                    }

                    $(function () {
                        var isErpCustomer = '@isErpCustomer'.toLowerCase();
                        if (isErpCustomer == 'true') {
                            ErpAccountCommon.loadProductB2BData("@productIds");
                        }
                    });


                    $('.not-logged-in-add-to-cart-button').on('click', function () {
                        B2BAjaxCart.promptForLogin();
                    });


                    function delay(fn, ms) {
                        let timer = 0
                        return function (args) {
                            clearTimeout(timer)
                            timer = setTimeout(fn.bind(this, args), ms || 0)
                        }
                    }

                    function productAddToCart(productId) {
                        var currentQuantity = parseInt($('.b2bProductQty_' + productId).val(), 10);
                        var shoppingCartTypeId = @shoppingCartTypeId;
                        var urlCheck = '@checkUserRegisteredLink';

                        B2BAjaxCart.checkUserRegisteredAndUpdateProductQuantity(currentQuantity, productId, urlCheck, shoppingCartTypeId)
                    }

                    function increaseQuantity(productId) {
                        var currentQuantity = parseInt($('.b2bProductQty_' + productId).val(), 10);
                        $('.b2bProductQty_' + productId).val(currentQuantity + 1)
                    }

                    function decreaseQuantity(productId) {
                        var currentQuantity = parseInt($('.b2bProductQty_' + productId).val(), 10);
                        if (currentQuantity > 1)
                            $('.b2bProductQty_' + productId).val(currentQuantity - 1)
                    }

                    if ($('.product-viewmode .viewmode-icon.list').hasClass('selected')) {
                        $('.category-header .right-column .category-image').show();
                    }

                </script>
            </div>
        </div>
    }
    else
    {
        if (Model.ViewMode == "list")
        {
            <div class="@Model.NopAjaxFiltersSettingsModel.ProductsListPanelSelector.TrimStart(new[] {'.'}) nop7SpikesAjaxFiltersGrid">
                <div class="item-grid">
                    @foreach (var product in Model.Products)
                    {
                        <div class="item-box">
                            @await Html.PartialAsync("_ProductBox", product)
                        </div>
                    }
                </div>
            </div>
        }
        else
        {
            <div class="@Model.NopAjaxFiltersSettingsModel.ProductsGridPanelSelector.TrimStart(new[] {'.'}) nop7SpikesAjaxFiltersGrid">
                <script>
                    if ($('.product-viewmode .viewmode-icon.grid').hasClass('selected')) {
                        $('.category-header .right-column .category-image').hide();
                    }
                </script>
                <div class="item-grid">
                    @foreach (var product in Model.Products)
                    {
                        <div class="item-box">
                            @await Html.PartialAsync("_ProductBox", product)
                        </div>
                    }
                </div>
            </div>
        }
    }
    var pager = Html.Pager(Model.PagingFilteringContext).QueryParam("pagenumber");

    if (!await pager.IsEmpty())
    {
        <div class="@Model.NopAjaxFiltersSettingsModel.PagerPanelSelector.TrimStart(new[] {'.'})">
            <div>
                @pager
            </div>
        </div>
    }
}