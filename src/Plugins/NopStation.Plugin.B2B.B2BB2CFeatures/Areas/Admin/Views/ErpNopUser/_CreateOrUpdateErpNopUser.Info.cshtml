@model ErpNopUserModel

<script>
    $(document).ready(function () {
        toggleRemoveButton();
    });

    function toggleRemoveButton() {
        if ($('#@Html.IdFor(model => model.NopCustomerId)').val() > 0) {
            $('#customer-name-remove').show();
        } else {
            $('#customer-name-remove').hide();
        }
    }
</script>
<div class="card-body">

    <div class="form-group row">
        <div class="col-md-3">
            <nop-label asp-for="NopCustomerId" />
        </div>
        @if (Model.Id > 0)
        {
            <div class="col-md-9 justify-content-center align-self-center">
                <input type="hidden" id="NopCustomerId" name="NopCustomerId" value=@Model.NopCustomerId />
                <a asp-controller="Customer" asp-action="Edit" asp-route-id="@Model.NopCustomerId">@Model.NopCustomer</a>
                <a class="btn btn-primary" asp-action="Impersonate" asp-route-id="@Model.NopCustomerId">Impersonate</a>
            </div>
        }
        else
        {
            <div class="col-md-9">
                <input type="hidden" asp-for="NopCustomerId" />
                <span id="customer-name">@Model.NopCustomer</span>
                <span asp-validation-for="NopCustomerId"></span>
                <button type="submit" onclick="javascript:OpenWindow('@(Url.Action("NopCustomerForErpUserPopup", "ErpNopUser",
                                                                    new {customerIdInput = Html.IdFor(model => model.NopCustomerId),
                                                                        customerNameInput = "customer-name", btnId = "btnRefreshSelectedCustomer"}))', 800, 850, true); return false;" class="btn btn-primary">
                    @T("Plugins.Payments.B2BCustomerAccount.Customer.Choose")
                </button>
                <button type="submit" id="customer-name-remove" class="btn bg-red">
                    @T("Plugins.Payments.B2BCustomerAccount.Customer.Remove")
                </button>
                <input type="submit" id="btnRefreshSelectedCustomer" style="display: none" />
                <script>
                $(document).ready(function () {
                    $('#customer-name-remove').click(function () {
                        $('#customer-name').text('');
                        $("#@Html.IdFor(model => model.NopCustomerId)").val(0);
                        toggleRemoveButton();
                        //return false to don't reload a page
                        return false;
                    });

                    $('#btnRefreshSelectedCustomer').click(function () {
                        toggleRemoveButton();

                        //return false to don't reload a page
                        return false;
                    });
                });
                </script>

            </div>
        }
    </div>

    <div class="form-group row">
        <div class="col-md-3">
            <nop-label asp-for="ErpUserTypeId" />
        </div>
        <div class="col-md-9">
            <nop-Select asp-for="ErpUserTypeId" asp-items="Model.AvailableErpUserTypes" asp-required="true" />
            <span asp-validation-for="ErpUserTypeId"></span>
        </div>
    </div>

    <div class="form-group row" id="customerRoleSection" hidden>
        <div class="col-md-3">
            <nop-label asp-for="SelectedCustomerRoleIds" />
        </div>
        <div class="col-md-9">
            <div class="input-group-append input-group-required">
                <div class="input-group">
                    <nop-select asp-for="SelectedCustomerRoleIds" asp-items="Model.AvailableCustomerRoles" asp-multiple="true" />
                </div>
                <div class="input-group-btn">
                    <nop-required />
                </div>
            </div>
            <span asp-validation-for="SelectedCustomerRoleIds"></span>
            <script>
                $(document).ready(function () {
                    var customerRoleIdsInput = $('#@Html.IdFor(model => model.SelectedCustomerRoleIds)');
                    customerRoleIdsInput.setOptions({
                        customerRoleIdsInput: false,
                        filter: "contains"
                    });

                    @if (Model.AvailableCustomerRoles.Count == 0)
                    {
                        <text>
                            customerRoleIdsInput.setOptions({
                            enable: false,
                            placeholder: '@T("Admin.Customers.Customers.Fields.CustomerRoles.NoRoles")'
                            });
                            customerRoleIdsInput._placeholder();
                            customerRoleIdsInput._enable();
                        </text>
                    }
                });
            </script>
        </div>
    </div>

    <div class="form-group row">
        <div class="col-md-3">
            <nop-label asp-for="ErpAccountId" />
        </div>

        @if (Model.ErpAccountId > 0)
        {
            <div class="col-md-9">
                <input type="hidden" id="ErpAccountId" name="ErpAccountId" value="@Model.ErpAccountId" />
                <a asp-controller="ErpAccount" asp-action="ErpAccountEdit" asp-route-id="@Model.ErpAccountId">@Model.ErpAccountInfo</a>
            </div>
        }
        else
        {
            <div class="col-md-9">
                <div class="input-group input-group-required">
                    <input type="text" id="search-account-code" autocomplete="on" placeholder="Search by Erp Account number" class="form-control" />
                    <div class="input-group-btn"><span class="required">*</span></div>
                </div>

                <span id="search-account-by-code"></span>
                <button type="button" id="search-account-clear" class="btn bg-gray" style="display: none; margin-top: 5px;">@T("Admin.Common.Clear")</button>
                <input asp-for="ErpAccountId" autocomplete="off" style="display: none;" />

                <script>
                    $(document).ready(function () {
                        $('#search-account-code').autocomplete({
                            delay: 500,
                            minLength: 3,
                            source: function (request, response) {
                            $.ajax({
                                url: '@(Url.Action("ErpAccountSearchAutoComplete", "ErpAccount"))',
                                dataType: 'json',
                                data: { term: request.term },
                                success: function (data) {
                                    // Check if there are no results
                                    if (data.length === 0) {
                                        response([{ label: 'No results found', value: '' }]);
                                    } else {
                                        response(data);
                                    }
                                }
                            });
                        },
                        select: function (event, ui) {
                            if (ui.item.value === '' || ui.item.label === 'No results found') {
                                // No actual item selected, handle accordingly
                                return false;
                            }
                            $('#@Html.IdFor(model => model.ErpAccountId)').val(ui.item.erpaccountid);
                            $('#search-account-by-code').text(ui.item.label);
                            $('#search-account-clear').show();
                            updateErpShipToAddresses(ui.item.erpaccountid);
                            return false;
                        }
                    });

                    //remove button
                    $('#search-account-clear').click(function () {
                            $('#@Html.IdFor(model => model.ErpAccountId)').val('0');
                            $('#search-account-by-code').text('');
                            $('#search-account-clear').hide();
                            return false;
                        });
                    });
                </script>
                <span asp-validation-for="ErpAccountId" id="validationMessageErpAccountId"></span>
            </div>
        }
    </div>

    @if (Model.ErpAccountId > 0)
    {
        <div class="form-group row">
            <div class="col-md-3">
                <nop-label asp-for="ErpSalesOrgId" />
            </div>
            <div class="col-md-9">
                <input type="hidden" id="ErpSalesOrgId" name="ErpSalesOrgId" value="@Model.ErpSalesOrgId" />
                <a asp-controller="ErpSalesOrg" asp-action="ErpSalesOrgEdit" asp-route-id="@Model.ErpSalesOrgId">@Model.ErpSalesOrg</a>
            </div>
        </div>
    }

    <div class="form-group row">
        <div class="col-md-3">
            <nop-label asp-for="ErpShipToAddressId" />
        </div>
        <div class="col-md-9">
            <nop-Select asp-for="ErpShipToAddressId" asp-items="Model.AvailableAddresses" asp-required="true" />
            <span asp-validation-for="ErpShipToAddressId"></span>
        </div>
    </div>

    <div class="form-group row">
        <div class="col-md-3">
            <nop-label asp-for="IsActive" />
        </div>
        <div class="col-md-9">
            <nop-editor asp-for="IsActive" />
            <span asp-validation-for="IsActive"></span>
        </div>
    </div>

    @if (Model.Id > 0)
    {
		<div class="form-group row">
			<div class="col-md-3">
				<nop-label asp-for="IsDateOfTermsAndConditionChecked" />
			</div>
			<div class="col-md-9">
				<nop-editor asp-for="IsDateOfTermsAndConditionChecked" />
				<span asp-validation-for="IsDateOfTermsAndConditionChecked"></span>
			</div>
		</div>
		<div class="form-group row">
			<div class="col-md-3">
				<nop-label asp-for="DateOfTermsAndConditionChecked" />
			</div>
			<div class="col-md-9 justify-content-center align-self-center">
				@Model.DateOfTermsAndConditionChecked
			</div>
		</div>
        <div class="form-group row">
            <div class="col-md-3">
                <nop-label asp-for="CreatedOn" />
            </div>
            <div class="col-md-9 justify-content-center align-self-center">
                @Model.CreatedOn
            </div>
        </div>

        <div class="form-group row">
            <div class="col-md-3">
                <nop-label asp-for="UpdatedOn" />
            </div>
            <div class="col-md-9 justify-content-center align-self-center">
                @Html.DisplayFor(model => model.UpdatedOn)
            </div>
        </div>
    }

</div>

<nop-alert asp-alert-id="statesAlert" asp-alert-message="@T("Admin.Common.Alert.States.Failed")" />

<script>
    function updateErpShipToAddresses(accountId) {
        $.ajax({
            type: 'GET',
            url: '@Url.Action("ShipToAddressDropdownList", "ErpNopUser")',
            data: { erpAccountId: accountId, customerId: @Model.NopCustomerId },
            success: function (data) {
                // Clear existing options in the ErpShipToAddressId dropdown
                $('#ErpShipToAddressId').empty();

                // Add new options based on the response data
                $.each(data, function (index, item) {
                    var option = $('<option></option>').val(item.Value).text(item.Text);
                    if (@Model.ErpShipToAddressId == item.Value) {
                        option.prop('selected', true); // Mark this option as selected
                    }
                    $('#ErpShipToAddressId').append(option);
                });
            },
            error: function (xhr, status, error) {
                console.error('Error fetching data:', error);
            }
        });
    }

    // Event listener for the AccountId dropdown change
    $('#ErpAccountId').on('change', function () {
        // Get the selected AccountId
        var selectedAccountId = $(this).val();
        // Call the method to update the ErpShipToAddressId dropdown
        updateErpShipToAddresses(selectedAccountId);
    });

    // Store all available roles with their original state
    var allAvailableRoles = [];
    var registeredRoleId = null;

    // Initialize the ErpShipToAddressId dropdown with the initial value of AccountId
    $(document).ready(function () {
        var initialAccountId = $('#ErpAccountId').val();
        // Call the method to update the ErpShipToAddressId dropdown
        updateErpShipToAddresses(initialAccountId);

        // Store all available roles from the select element
        var customerRoleSelect = $('#@Html.IdFor(model => model.SelectedCustomerRoleIds)');
        customerRoleSelect.find('option').each(function() {
            var option = $(this);
            allAvailableRoles.push({
                value: option.val(),
                text: option.text()
            });

            // Find and store registered role ID
            if (option.text().includes('@NopCustomerDefaults.RegisteredRoleName')) {
                registeredRoleId = option.val();
            }
        });

        // Add event listener for customer selection change
        $('#@Html.IdFor(model => model.NopCustomerId)').on('change', handleCustomerChange);

        // Trigger the user type change handler with a slight delay
        setTimeout(function() {
            handleUserTypeChange(true); // true indicates initial load
        }, 100);
    });

    // Handle customer dropdown change
    function handleCustomerChange() {
        var customerId = $('#@Html.IdFor(model => model.NopCustomerId)').val();

        if (!customerId || customerId === '0') {
            // If no customer is selected, reset the customer role selection
            var customerRoleSelect = $('#@Html.IdFor(model => model.SelectedCustomerRoleIds)');
            customerRoleSelect.val(null).trigger('change');
        } else {
            // If a customer is selected, ensure the handleUserTypeChange function is called
            // which will ensure the Registered role is selected
            handleUserTypeChange(false);
        }
    }

    // Attach the change event handler for user type
    $('#ErpUserTypeId').on('change', function() {
        handleUserTypeChange(false);
    });

    // Handle ErpUserTypeId change
    function handleUserTypeChange(isInitialLoad) {
        var selectedUserType = $('#ErpUserTypeId').val();
        var customerRoleSelect = $('#@Html.IdFor(model => model.SelectedCustomerRoleIds)');
        var customerId = $('#@Html.IdFor(model => model.NopCustomerId)').val();

        // If no user type is selected or it's the default "0" value, hide the customer role section
        if (!selectedUserType || selectedUserType === '0') {
            $('#customerRoleSection').attr('hidden', 'hidden');
            return;
        }

        // Show the customer roles section by removing the hidden attribute
        $('#customerRoleSection').removeAttr('hidden');

        // Ensure Select2 container has 100% width
        $('.select2-container').css('width', '100%');

        // Get currently selected role IDs
        var selectedRoleIds = customerRoleSelect.val() || [];

        // Filter roles based on user type without recreating the dropdown
        var filteredRoles = allAvailableRoles.filter(function(role) {
            if (selectedUserType === '@((int)ErpUserType.B2BUser)') {
                return !(role.text.includes('@ERPIntegrationCoreDefaults.B2CCustomerRole') || 
                    role.text.includes('@ERPIntegrationCoreDefaults.B2CCustomerRole') ||
                    role.text.includes('B2C Registration Unsuccessful') ||
                    role.text.includes('NoShop') ||
                    (role.text.includes('B2C') && !role.text.includes('B2B-B2C Admin')));
            } else if (selectedUserType === '@((int)ErpUserType.B2CUser)') {
                return !(role.text.includes('@ERPIntegrationCoreDefaults.B2BCustomerRole') ||
                    role.text.includes('@ERPIntegrationCoreDefaults.B2BB2CAdminRole') ||
                    role.text.includes('@ERPIntegrationCoreDefaults.B2BSalesRepRole') ||
                    role.text.includes('@ERPIntegrationCoreDefaults.QuickOrderUserRole') ||
                    role.text.includes('@ERPIntegrationCoreDefaults.B2BQuoteAssistantRole') ||
                    role.text.includes('@ERPIntegrationCoreDefaults.B2BCustomerAccountManagerRole') ||
                    role.text.includes('@ERPIntegrationCoreDefaults.B2BCustomerAccountingPersonnelRole') ||
                    role.text.includes('Erp Webhook Manager') ||
                    (role.text.includes('B2B') && !role.text.includes('B2B-B2C Admin')));
            }
            return true;
        });

        // Clear the dropdown and add filtered options
        customerRoleSelect.empty();
        filteredRoles.forEach(function(role) {
            customerRoleSelect.append(new Option(role.text, role.value, false, selectedRoleIds.includes(role.value)));
        });

        // Ensure registered role is selected if we have a customer
        if (customerId && customerId !== '0' && registeredRoleId) {
            // Get current selections after filtering
            var currentSelections = customerRoleSelect.val() || [];

            // Add registered role if not already selected
            if (!currentSelections.includes(registeredRoleId)) {
                currentSelections.push(registeredRoleId);
                customerRoleSelect.val(currentSelections);
            }
        }

        // If no roles are selected, select registered role by default
        if ((!customerRoleSelect.val() || customerRoleSelect.val().length === 0) && registeredRoleId) {
            customerRoleSelect.val([registeredRoleId]);
        }

        // Only trigger change if this isn't the initial load
        // This prevents the Select2 from re-rendering unnecessarily
        if (!isInitialLoad) {
            customerRoleSelect.trigger('change');
        }
    }
</script>