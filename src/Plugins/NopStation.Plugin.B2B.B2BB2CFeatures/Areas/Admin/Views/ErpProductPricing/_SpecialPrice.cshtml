@model ErpSpecialPriceSearchModel
@using NopStation.Plugin.B2B.B2BB2CFeatures.Areas.Admin.Models

@{
    var customer = await workContext.GetCurrentCustomerAsync();
    const string hideErpSpecialPriceSearchBlockAttributeName = "ErpSpecialPriceList.HideSearchBlock";
    var hideErpSpecialPriceSearchBlock = await genericAttributeService.GetAttributeAsync<bool>(customer, hideErpSpecialPriceSearchBlockAttributeName);
}

<div class="card card-default card-search">
    <div class="card-body">
        <div class="row search-row @(!hideErpSpecialPriceSearchBlock ? "opened" : "")" data-hideAttribute="@hideErpSpecialPriceSearchBlockAttributeName">
            <div class="search-text">@T("Admin.Common.Search")</div>
            <div class="icon-search"><i class="fas fa-search" aria-hidden="true"></i></div>
            <div class="icon-collapse"><i class="fas fa-angle-down" aria-hidden="true"></i></div>
        </div>
        <div class="search-body @(hideErpSpecialPriceSearchBlock ? "closed" : "")">
            <div class="form-group row">
                <div class="col-md-5">
                    <div class="form-group row">
                        <div class="col-md-4">
                            <nop-label asp-for="SearchErpAccountId" />
                        </div>
                        <div class="col-md-8">
                            <input type="text" id="search-account-code" autocomplete="off" placeholder="Search by Erp Account number" class="form-control" />
                            <span id="search-account-by-code"></span>
                            <button type="button" id="search-account-clear" class="btn bg-gray" style="display: none; margin-top: 5px;">@T("Admin.Common.Clear")</button>
                            <input asp-for="SearchErpAccountId" autocomplete="off" style="display: none;" />
                            <script>
                                $(document).ready(function () {
                                    $('#search-account-code').autocomplete({
                                        delay: 500,
                                        minLength: 3,
                                        source: function (request, response) {
                                            $.ajax({
                                                url: '@(Url.Action("ErpAccountSearchAutoComplete", "ErpAccount"))',
                                                dataType: 'json',
                                                data: { term: request.term },
                                                success: function (data) {
                                                    // Check if there are no results
                                                    if (data.length === 0) {
                                                        response([{ label: 'No results found', value: '' }]);
                                                    } else {
                                                        response(data);
                                                    }
                                                }
                                            });
                                        },
                                        select: function (event, ui) {
                                            if (ui.item.value === '' || ui.item.label === 'No results found') {
                                                // No actual item selected, handle accordingly
                                                return false;
                                            }
                                            $('#@Html.IdFor(model => model.SearchErpAccountId)').val(ui.item.erpaccountid);
                                            $('#search-account-by-code').text(ui.item.label);

                                            $('#search-account-clear').show();
                                            $('#validationMessageErpAccountId').hide();
                                            return false;
                                        }
                                    });

                                    //remove button
                                    $('#search-account-clear').click(function () {
                                        $('#@Html.IdFor(model => model.SearchErpAccountId)').val('0');
                                        $('#search-account-by-code').text('');
                                        $('#search-account-clear').hide();
                                        return false;
                                    });
                                });
                            </script>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <div class="text-center col-md-12">
                    <button type="button" id="search-special-price" class="btn btn-primary btn-search">
                        <i class="fas fa-search"></i>
                        @T("Admin.Common.Search")
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="card-body">
    <div class="card card-default">
        <div class="card-body">
            @{
                var gridModel = new DataTablesModel
                {
                    Name = "special-price-grid",
                    UrlRead = new DataUrl("ProductPricingList", "ErpProductPricing", new RouteValueDictionary { [nameof(ErpSpecialPriceSearchModel.ProductId)] = Model.ProductId }),
                    UrlDelete = new DataUrl("DeleteSpecialPrice", "ErpProductPricing", null),
                    SearchButtonId = "search-special-price",
                    Length = Model.PageSize,
                    LengthMenu = Model.AvailablePageSizes,
                    Filters = new List<FilterParameter>
                    {
                        new FilterParameter(nameof(Model.SearchErpAccountId))
                    }
                };

                gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ErpSpecialPriceModel.ErpAccountNumber))
                {
                    Title = T("Plugin.Misc.NopStation.ERPIntegrationCore.ErpSpecialPrice.Fields.ErpAccount").Text,
                    Width = "200",
                    Render = new RenderLink(new DataUrl("~/Admin/ErpAccount/ErpAccountEdit", nameof(ErpSpecialPriceModel.ErpAccountId)))
                });

                gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ErpSpecialPriceModel.ErpAccountSalesOrgName))
                {
                    Title = T("Plugin.Misc.NopStation.ERPIntegrationCore.ErpSpecialPrice.Fields.ErpAccountSalesOrg").Text,
                    Width = "200",
                    Render = new RenderLink(new DataUrl("~/Admin/ErpSalesOrg/ErpSalesOrgEdit", nameof(ErpSpecialPriceModel.ErpAccountSalesOrgId)))
                });

                gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ErpSpecialPriceModel.Price))
                {
                    Title = T("Plugin.Misc.NopStation.ERPIntegrationCore.ErpSpecialPrice.Fields.Price").Text,
                    Width = "200"
                });

                gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ErpSpecialPriceModel.PricingNote))
            {
                Title = T("Plugin.Misc.NopStation.ERPIntegrationCore.ErpSpecialPrice.Fields.PricingNote").Text,
                Width = "200"
            });
				gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ErpSpecialPriceModel.DiscountPerc))
			{
				Title = T("Plugin.Misc.NopStation.ERPIntegrationCore.ErpSpecialPrice.Fields.DiscountPerc").Text,
				Width = "200"
			});

                gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ErpSpecialPriceModel.Id))
            {
                Title = T("Admin.Common.Edit").Text,
                Width = "100",
                ClassName = NopColumnClassDefaults.Button,
                Render = new RenderCustom("renderColumnSpecialPriceEdit")
            });

                gridModel.ColumnCollection.Add(new ColumnProperty(nameof(ErpSpecialPriceModel.Id))
            {
                Title = T("Admin.Common.Delete").Text,
                Width = "100",
                Render = new RenderButtonRemove(T("Admin.Common.Delete").Text),
                ClassName = NopColumnClassDefaults.Button
            });
            }
            @await Html.PartialAsync("Table", gridModel)
        </div>
        <div class="card-footer">
            <div width="100%">
                <button type="submit" id="btnAddNewSpecialPrice"
                        onclick="javascript:OpenWindow('@(Url.Action("SpecialPriceCreatePopUp", "ErpProductPricing", new { productId = Model.ProductId, btnId = "btnRefresh", formId = "product-pricing-form" }))', 800, 450, true); return false;"
                        class="btn btn-primary float-right">
                    @T("Plugin.Misc.NopStation.ERPIntegrationCore.ErpSpecialPrice.List.AddNew")
                </button>
                <button type="submit" id="btnRefresh" style="display: none" />
                <script>
                    $(document).ready(function () {
                        $('#btnRefresh').click(function () {
                            //refresh grid
                            updateTable('#special-price-grid');

                            //return false to don't reload a page
                            return false;
                        });
                    });
                </script>
            </div>
        </div>
    </div>
</div>

<script>
    function renderColumnSpecialPriceEdit(data, type, row, meta) {
        return '<button onclick=\"javascript:OpenWindow(\'@Url.Content("~/Admin/ErpProductPricing/SpecialPriceEditPopUp/")' + data + '?btnId=btnRefresh&formId=product-pricing-form\', 800, 400, true); return false;\" class="btn btn-default"><i class="fas fa-pencil-alt"></i>@T("Admin.Common.Edit")</button>';
    }
</script>

<style>
    .button-column {
        text-align: center !important;
    }
</style>