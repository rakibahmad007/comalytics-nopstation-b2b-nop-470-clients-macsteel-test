@using Nop.Web.Components
@using Nop.Web.Framework.TagHelpers.Shared
@using Microsoft.AspNetCore.Mvc.TagHelpers
@model AddressModel
@inject B2BB2CFeaturesSettings googleMapsIntegrationSettings

@{
    var prefix = "ACC";
}

<input class="address-id" asp-for="Id" type="hidden"/>
<div class="edit-address">
    <div class="map-header">
        <h2>@T("NopStation.Plugin.B2B.B2BB2CFeatures.HeaderForMapAddress")</h2>
    </div>
    <div class="map-card">
        <input
            id="pac-input_@prefix"
            class="pac-input controls"
            type="text"
            placeholder="@T("NopStation.Plugin.B2B.B2BB2CFeatures.MapSearchBoxPlaceholder")" />
        <div id="map_@prefix" class="map"></div>
        <div id="infowindow-content_@prefix" class="infowindow-content">
            <span id="place-name"></span><br />
            <span id="place-address"></span><br />
            <span id="place-lng"></span>
            <span id="place-lat"></span>
        </div>
    </div>
        
    <script>
        function initMap_@prefix () {
            const firstNameSelectElement = document.querySelector(`#` + `@prefix` +  `_FirstName`);
            const lastNameSelectElement = document.querySelector(`#` + `@prefix` +  `_LastName`);
            const countrySelectElement = document.querySelector(`#` + `@prefix` +  `_CountryId`);
            const cityInputElement = document.querySelector(`#` + `@prefix` +  `_City`);
            const address1InputElement = document.querySelector(`#` + `@prefix` +  `_Address1`);
            const zipPostalCodeInputElement = document.querySelector(`#` + `@prefix` +  `_ZipPostalCode`);
            const stateProvinceInputElement = document.querySelector(`#` + `@prefix` +  `_StateProvinceId`);
            
            var center = new google.maps.LatLng(@googleMapsIntegrationSettings.Latitude, @googleMapsIntegrationSettings.Longitude);
            const input = document.getElementById("pac-input_@prefix");
    
            const markerArray = [];
            const map = new google.maps.Map(document.getElementById("map_@prefix"), {
                center: center,
                zoom: 13,
                mapTypeControl: true,  
                draggableCursor: 'default',
                mapTypeControlOptions: {
                  style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                  position: google.maps.ControlPosition.BOTTOM_LEFT
                },
                fullscreenControl : true,
                fullscreenControlOptions : {
                  position: google.maps.ControlPosition.BOTTOM_RIGHT
                },
            });
    
            map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
           
            let geoLocationOption = () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const pos = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                            };
                            map.setCenter(pos);
                        },
                        () => {
                            handleLocationError_@prefix (true, map.getCenter());
                        }
                    );
                } else {
                    handleLocationError_@prefix (false, map.getCenter());
                }
            }
    
            const options = {
                //componentRestrictions: { country: ["za"] }, // restrict suggestions within south africa only
                fields: ["address_components", "formatted_address", "geometry", "name"],
                strictBounds: false,
            };
            const autocomplete = new google.maps.places.Autocomplete(input, options);
            autocomplete.bindTo("bounds", map);
    
            const geocoder = new google.maps.Geocoder();
    
            const infowindow = new google.maps.InfoWindow();
            const infowindowContent = document.getElementById("infowindow-content_@prefix");
    
            infowindow.setContent(infowindowContent);
    
            var marker = new google.maps.Marker({
                map,
                anchorPoint: new google.maps.Point(0, -29),
            });
            
            autocomplete.addListener("place_changed", () => {
              resetData_@prefix ();
              clearMarkers_@prefix ();
    
              const place = autocomplete.getPlace();
    
              if (!place.geometry || !place.geometry.location) {
                  return;
              }
    
              if (place.geometry.viewport) {
                  map.fitBounds(place.geometry.viewport);
              } else {
                  map.setCenter(place.geometry.location);
                  map.setZoom(15);
              }
    
              addMarker_@prefix (place.geometry.location, map); //pin the selected place
    
              infowindow.close();
              marker.setVisible(false);
    
              setInfoWindowFields_@prefix (place);
              setAddressFields_@prefix (place.address_components);
          });
    
          google.maps.event.addListener(map, "click", (event) => {
              event.stop();
              resetData_@prefix ();
              clearMarkers_@prefix ();
              addMarker_@prefix (event.latLng, map); 
    
              if (event.placeId) {
                  getPlaceInformation_@prefix (event.placeId);
              }
              else {
                  geocoder
                      .geocode({ location: event.latLng })
                      .then((response) => {
                          if (response.results[0]) {
                              if (response.results[0].geometry.viewport) {
                                  map.fitBounds(response.results[0].geometry.viewport);
                              } else {
                                  map.setCenter(response.results[0].geometry.location);
                                  map.setZoom(17);
                              }
    
                              setInfoWindowFields_@prefix (response.results[0]);
                              setAddressFields_@prefix (response.results[0].address_components);
                          } else {
                          }
                      })
                      .catch((e) => console.log("Geocoder failed due to: " + e));
              }
          });
    
          function getPlaceInformation_@prefix (placeId) {
              infowindow.close();
              marker.setVisible(false);
    
              const place_service = new google.maps.places.PlacesService(map);
    
              place_service.getDetails({ placeId: placeId }, (place, status) => {
    
                  if (!place.geometry || !place.geometry.location) {
                      return;
                  }
    
                  if (status == google.maps.places.PlacesServiceStatus.OK && place && place.geometry && place.geometry.location) {
                      if (place.geometry.viewport) {
                          map.fitBounds(place.geometry.viewport);
                      } else {
                          map.setCenter(place.geometry.location);
                          map.setZoom(17);
                      }
    
                      setInfoWindowFields_@prefix (place);
                      setAddressFields_@prefix (place.address_components);
                  }
              });
          }
    
          function addMarker_@prefix (location, map) {
              marker = new google.maps.Marker({
                  position: location,
                  map: map,
              });
    
              markerArray.push(marker);
          }
    
          function clearMarkers_@prefix () {
              for (var i = 0; i < markerArray.length; i++) {
                  markerArray[i].setMap(null);
              }
          }
    
          function resetData_@prefix () {
              if (countrySelectElement) {
                countrySelectElement.value = "";
              }
              if (zipPostalCodeInputElement) {
                 zipPostalCodeInputElement.value = "";
              }
              if (address1InputElement) {
                 address1InputElement.value = "";
              }
              if (stateProvinceInputElement) {
                 stateProvinceInputElement.value = "";
              }
              if (cityInputElement) {
                  cityInputElement.value = "";
              }
    
               infowindowContent.children["place-name"].textContent = "";
               infowindowContent.children["place-address"].textContent = "";
               infowindowContent.children["place-lng"].textContent = "";
               infowindowContent.children["place-lat"].textContent = "";
          }
    
          function setInfoWindowFields_@prefix (placeInfo) {
              marker.setPosition(placeInfo.geometry.location);
              marker.setVisible(true);
    
              var placeName = "";
              if (placeInfo.name)
                  placeName = placeInfo.name + ", ";
    
              infowindowContent.children["place-name"].textContent = placeName;
              infowindowContent.children["place-address"].textContent = placeInfo.formatted_address;
              infowindowContent.children["place-lng"].textContent = placeInfo.geometry.location.lng();
              infowindowContent.children["place-lat"].textContent = placeInfo.geometry.location.lat();
  
              infowindow.open(map, marker);
    
              input.value = placeName + placeInfo.formatted_address;
          }
          
          async function getCountry_@prefix (code) {
            const rawResponse =  await fetch(`/GetCountryTwoLetterIsoCode/${code}`, {
              method: 'Get',
              headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
              },
            });
          
            let content = await rawResponse.json();
            return content.Id;
          }
          
          function setAddressFields_@prefix (address_components) {
              console.log(address_components);
              var addressComponents = address_components;
              let address1 = "";
              for (const component of addressComponents) {
                  const componentType = component.types;
    
                  if (componentType.includes("street_number")) {
                      let value = component.long_name;
                      
                      if (value) {
                          address1 += value + " ";
                      }
                  }
                  else if (componentType.includes("route")) {
                      let value = component.long_name;
                                            
                      if (value) {
                          address1 += value + " ";
                      }
                  }
                  else if (componentType.includes("postal_code") && zipPostalCodeInputElement) {
                      zipPostalCodeInputElement.value = component.long_name;
                  }
                  else if (componentType.includes("locality") && cityInputElement) {
                      cityInputElement.value = component.long_name;
                  }
                  else if (componentType.includes("sublocality")) {
                        let value = component.long_name;
                                              
                        if (value) {
                            address1 += value + " ";
                        }
                  }
                  else if (componentType.includes("sublocality_level_1")) {
                        let value = component.long_name;
                                              
                        if (value) {
                            address1 += value + " ";
                        }
                  }
                  else if (componentType.includes("sublocality_level_2")) {
                        let value = component.long_name;
                                              
                        if (value) {
                            address1 += value + " ";
                        }
                  }
                  else if (componentType.includes("administrative_area_level_1") && stateProvinceInputElement) {
                  }
                  else if (componentType.includes("country") && countrySelectElement) {
                      (async() => {
                          countrySelectElement.value = await getCountry_@prefix (component.short_name);
                          countrySelectElement.dispatchEvent(new Event('change'));
                      })();
                  }
              }
              
              if (address1InputElement) {
                address1InputElement.value = address1;
              }
          }
          
          function handleLocationError_@prefix (browserHasGeolocation, pos) {
              browserHasGeolocation
                  ? console.log("Error: The Geolocation service failed")
                  : console.log("Error: The browser doesn't support geolocation");
    
              map.setCenter(pos);
          }
    }
  
    window.initMap_@prefix = initMap_@prefix;
    window.onload = function () {
      initMap_@prefix ();
    };
    
    setTimeout(() => {
        initMap_@prefix ();
    }, 100)
    
    </script>

    <div class="fieldset">
        <div class="title"><strong>Address</strong></div>
        <div class="form-fields">
            @* <div class="inputs">
                <label asp-for="FirstName" asp-postfix=":"></label>
                <input asp-for="FirstName" id="ACC_FirstName" />
                <nop-required />
                <span asp-validation-for="FirstName"></span>
            </div>
            <div class="inputs">
                <label asp-for="LastName" asp-postfix=":"></label>
                <input asp-for="LastName" id="ACC_LastName" />
                <nop-required />
                <span asp-validation-for="LastName"></span>
            </div> *@
            <div class="inputs">
                <label asp-for="Email" asp-postfix=":"></label>
                <input asp-for="Email" id="ACC_Email" />
                <nop-required />
                <span asp-validation-for="Email"></span>
            </div>
    
            @* @if (Model.CompanyEnabled)
            {
                <div class="inputs">
                    <label asp-for="Company" asp-postfix=":"></label>
                    <input asp-for="Company" id="ACC_Company" />
                    @if (Model.CompanyRequired)
                    {
                        <nop-required />
                    }
                    <span asp-validation-for="Company"></span>
                </div>
            } *@

            <div class="inputs">
                <label asp-for="PhoneNumber" asp-postfix=":"></label>
                <input asp-for="PhoneNumber" id="ACC_PhoneNumber" />
                @if (Model.PhoneRequired)
                {
                    <nop-required />
                }
                <span asp-validation-for="PhoneNumber"></span>
            </div>
    
            @* @if (Model.FaxEnabled)
            {
                <div class="inputs">
                    <label asp-for="FaxNumber" asp-postfix=":"></label>
                    <input asp-for="FaxNumber" id="ACC_FaxNumber" />
                    @if (Model.FaxRequired)
                    {
                        <nop-required />
                    }
                    <span asp-validation-for="FaxNumber"></span>
                </div>
            } *@
    
            @if (Model.CustomAddressAttributes.Count > 0)
            {
                @await Html.PartialAsync("_AddressAttributes", Model.CustomAddressAttributes)
            }

            <div class="inputs">
                <label asp-for="Address1" asp-postfix=":"></label>
                <input asp-for="Address1" id="ACC_Address1" class="address-address1" />
                @if (Model.StreetAddressRequired)
                {
                    <nop-required />
                }
                <span asp-validation-for="Address1"></span>
            </div>
    
            <div class="inputs">
                <label asp-for="Address2" asp-postfix=":"></label>
                <input asp-for="Address2" id="ACC_Address2" />
                @if (Model.StreetAddress2Required)
                {
                    <nop-required />
                }
                <span asp-validation-for="Address2"></span>
            </div>

            <div class="inputs">
                <label asp-for="CountryId" asp-postfix=":"></label>
                <select asp-for="CountryId" asp-items="Model.AvailableCountries"  id="ACC_CountryId"
                        data-trigger="country-select"
                        data-url="@(Url.RouteUrl("GetStatesByCountryId"))"
                        class="address-country"
                        data-stateprovince="#ACC_StateProvinceId"
                        data-loading="#states-loading-progress"></select>
                <nop-required />
                <span asp-validation-for="CountryId"></span>
            </div>

            <div class="inputs">
                <label asp-for="StateProvinceId" asp-postfix=":"></label>
                <select asp-for="StateProvinceId" asp-items="Model.AvailableStates" id="ACC_StateProvinceId"
                        class="address-state"
                        data-trigger="state-select">
                </select>
                <span id="states-loading-progress" style="display: none;" class="please-wait">@T("Common.Wait")</span>
                <span asp-validation-for="StateProvinceId"></span>
            </div>
    
            <div class="inputs">
                <label asp-for="County" asp-postfix=":"></label>
                <input asp-for="County" id="ACC_County" />
                @if (Model.CountyRequired)
                {
                    <nop-required />
                }
                <span asp-validation-for="County"></span>
            </div>
    
            <div class="inputs">
                <label asp-for="City" asp-postfix=":"></label>
                <input asp-for="City" id="ACC_City" class="address-city"/>
                @if (Model.CityRequired)
                {
                    <nop-required />
                }
                <span asp-validation-for="City"></span>
            </div>
    
            <div class="inputs">
                <label asp-for="ZipPostalCode" asp-postfix=":"></label>
                <input asp-for="ZipPostalCode" id="ACC_ZipPostalCode" class="address-zip-postal-code"/>
                @if (Model.ZipPostalCodeRequired)
                {
                    <nop-required />
                }
                <span asp-validation-for="ZipPostalCode"></span>
            </div>
    
            @await Component.InvokeAsync(typeof(WidgetViewComponent), new { widgetZone = PublicWidgetZones.AddressBottom, additionalData = Model })
        </div>
    </div>
</div>
